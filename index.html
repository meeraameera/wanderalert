<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WanderAlert Event Logs</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        header {
            background-color: #4c53af;
            padding: 20px;
            text-align: center;
            color: white;
        }

        h1 {
            margin: 0;
            font-size: 2.5em;
        }

        p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
        }

        #loginForm {
            padding: 20px;
            background-color: white;
            max-width: 400px;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #loginForm input {
            max-width: 300px;
            /* Adjust box length */
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }

        #loginForm button {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            border-radius: 4px;
            background-color: #4c53af;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }

        #filters {
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        #filters select,
        #filters button {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #filters button {
            background-color: #4c53af;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        section#logs {
            padding: 20px;
            flex-grow: 1;
        }

        ul#logList {
            list-style-type: none;
            padding: 0;
        }

        ul#logList li {
            background-color: #ffffff;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        ul#logList li:hover {
            transform: scale(1.02);
            background-color: #f9f9f9;
        }

        ul#logList img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin-right: 15px;
        }

        footer {
            text-align: center;
            padding: 10px;
            background-color: #333;
            color: white;
        }

        canvas {
            margin: 20px auto;
            display: block;
        }
    </style>

</head>

<body>
    <header>
        <h1>WanderAlert Event Logs</h1>
        <p id="userInfo">Please log in to view event logs.</p>
    </header>

    <!-- Login Form Section -->
    <div id="loginForm">
        <input type="email" id="email" placeholder="Enter your email" required>
        <input type="password" id="password" placeholder="Enter your password" required>
        <button id="loginButton">Login</button>
    </div>

    <!-- Filters for selecting logs by month -->
    <section id="filters" style="display: none;">
        <label for="monthSelect">Select Month:</label>
        <select id="monthSelect"></select>
        <button onclick="filterByMonth()">Filter Logs</button>
        <button onclick="showAllLogs()">Show All Logs</button>
        <button id="updateLogsButton">Update Logs</button>
    </section>

    <!-- Event logs section -->
    <section id="logs" style="display: none;">
        <ul id="logList"></ul>
    </section>

    <!-- Canvas for displaying the event chart -->
    <canvas id="eventChart" width="400" height="200" style="display: none;"></canvas>

    <footer>
        <p>&copy; 2025 WanderAlert. All rights reserved.</p>
    </footer>

    <!-- Import Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // API endpoints for login and fetching logs
        const loginApiEndpoint = 'https://b43l3tc549.execute-api.us-east-1.amazonaws.com/prod/login';
        const apiEndpoint = 'https://2724zculm9.execute-api.us-east-1.amazonaws.com/prod/logs';

        // Login button event listener
        document.getElementById('loginButton').addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                document.getElementById('userInfo').innerText = 'Both fields are required.';
                return;
            }

            try {
                // Send login request to the server
                const response = await fetch(loginApiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                // Handle successful or failed login
                if (response.status === 200) {
                    document.getElementById('userInfo').innerText = 'Login successful, here are the logs!';
                    document.getElementById('loginForm').style.display = 'none';
                    document.querySelectorAll('#filters, #logs, #eventChart').forEach(el => el.style.display = 'block');
                    showAllLogs();  // Fetch logs after successful login
                } else {
                    document.getElementById('userInfo').innerText = result.message;
                }
            } catch (error) {
                console.error('Error during login:', error);
                document.getElementById('userInfo').innerText = 'An error occurred. Please try again.';
            }
        });

        // Update logs button event listener
        document.getElementById('updateLogsButton').addEventListener('click', async () => {
            try {
                const logs = await fetchLogs();  // Fetch logs from the server
                displayLogs(logs);  // Update log list
                loadChartData(logs);  // Update the graph
                console.log('Logs and chart updated successfully');
            } catch (error) {
                console.error('Error updating logs and chart:', error);
                document.getElementById('userInfo').innerText = 'Failed to update logs and chart. Please try again.';
            }
        });

        // Populate the month selector with options
        function populateMonthSelector() {
            const monthSelect = document.getElementById('monthSelect');
            const currentYear = new Date().getFullYear();

            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, new Date().getMonth() - i, 1);
                const monthYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                const optionValue = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                monthSelect.add(new Option(monthYear, optionValue));
            }
        }

        // Fetch logs from DynamoDB using the API endpoint
        async function fetchLogs() {
            const response = await fetch(apiEndpoint);
            const logs = await response.json();
            return Array.isArray(logs) ? logs : JSON.parse(logs.body);
        }

        // Display the list of event logs on the page
        function parseCustomTimestamp(timestamp) {
            // Convert dd-mm-yyyy HH:MM:SS to Date object
            const [day, month, yearAndTime] = timestamp.split('-');
            const [year, time] = yearAndTime.split(' ');
            return new Date(`${year}-${month}-${day}T${time}`);
        }

        function displayLogs(logs) {
            // Sort logs in descending order based on the custom timestamp
            logs.sort((a, b) => {
                const dateA = parseCustomTimestamp(a.timestamp);
                const dateB = parseCustomTimestamp(b.timestamp);
                return dateB - dateA;  // Descending order (newest first)
            });

            const logList = document.getElementById('logList');
            logList.innerHTML = '';

            if (logs.length === 0) {
                logList.innerHTML = '<li>No events logged yet.</li>';
            } else {
                logs.forEach(log => {
                    const imageUrl = `https://wanderalertsensor-images.s3.amazonaws.com/${log.imageKey}`;
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                <img src="${imageUrl}" alt="Event Image">
                <div>
                    <strong>${log.recognizedName}</strong> was detected and opened the door at <strong>${log.timestamp}</strong>.
                </div>
            `;
                    logList.appendChild(listItem);
                });
            }
        }

        // Filter logs by the selected month
        async function filterByMonth() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const [year, month] = selectedMonth.split('-');

            const logs = await fetchLogs();
            const filteredLogs = logs.filter(log => {
                const [day, monthString, yearString] = log.timestamp.split(' ')[0].split('-');
                const logDate = new Date(`${yearString}-${monthString}-${day}`);

                return logDate.getFullYear() === parseInt(year) && (logDate.getMonth() + 1) === parseInt(month);
            });

            displayLogs(filteredLogs);
            loadChartData(filteredLogs);
        }

        // Display all logs
        async function showAllLogs() {
            const logs = await fetchLogs();
            displayLogs(logs);
            loadChartData(logs);
        }

        // Load data into the chart
        let chartInstance = null;  // Store the chart instance globally

        function loadChartData(logs) {
            const timestamps = logs.map(log => log.timestamp);
            const occurrences = new Array(timestamps.length).fill(1);

            const ctx = document.getElementById('eventChart').getContext('2d');

            // Destroy the existing chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Create a new chart with the latest data
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Door Events Over Time',
                        data: occurrences,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Timestamp'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Events'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Initial setup to populate the month selector
        (async () => {
            populateMonthSelector();
        })();
    </script>
</body>

</html>